<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Valentine Puzzle</title>

  <style>
    :root{
      --pink1:#ff4d8d;
      --pink2:#ff7eb3;

      --text:#5a0040;
      --muted:rgba(90,0,64,0.65);

      --card:rgba(255,255,255,0.70);
      --border:rgba(255,105,180,0.25);
      --shadow:0 25px 60px rgba(255,105,180,0.28);

      --trayW:66px;
      --trayH:110px;
    }

    html, body{ overscroll-behavior-y: none; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:20px 0;
      color:var(--text);

      background:
        radial-gradient(circle at 18% 22%, rgba(255,255,255,0.35), transparent 40%),
        radial-gradient(circle at 82% 72%, rgba(255,255,255,0.35), transparent 42%),
        linear-gradient(135deg,var(--pink2),var(--pink1));
      touch-action: pan-y;
      overflow-x:hidden;
      position:relative;
    }

    body::before{
      content:"‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§ ‚ù§";
      position:fixed;
      inset:-40px;
      font-size:86px;
      line-height:1.9;
      letter-spacing:18px;
      color:rgba(255,255,255,0.08);
      display:flex;
      flex-wrap:wrap;
      align-content:center;
      justify-content:center;
      pointer-events:none;
      z-index:0;
      transform:rotate(-8deg);
    }

    /* floating hearts background */
    .float-hearts{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:1;
      overflow:hidden;
    }
    .heart{
      position:absolute;
      bottom:-60px;
      font-size:22px;
      opacity:0.20;
      color:rgba(255,255,255,0.95);
      text-shadow:0 10px 30px rgba(255,105,180,0.25);
      animation:
        rise var(--dur) linear var(--delay) infinite,
        sway var(--swayDur) ease-in-out var(--delay) infinite,
        twinkle var(--twDur) ease-in-out var(--delay) infinite;
      will-change: transform, opacity, filter;
      filter: blur(0.15px);
    }
    @keyframes rise{
      from{ transform: translateY(0) translateX(0) rotate(0deg) scale(var(--scale)); }
      to  { transform: translateY(-125vh) translateX(var(--drift)) rotate(var(--rot)) scale(calc(var(--scale) * 1.25)); }
    }
    @keyframes sway{
      0%,100%{ margin-left:0px; }
      50%{ margin-left:var(--sway); }
    }
    @keyframes twinkle{
      0%,100%{ opacity:0.10; filter:blur(0.2px); }
      50%{ opacity:0.38; filter:blur(0px); }
    }

    #board, #tray{ touch-action: pan-y; }
    .piece{ touch-action: none; }

    #confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:9998;
    }

    .card{
      width:min(1040px,95vw);
      background:var(--card);
      backdrop-filter:blur(14px);
      border-radius:26px;
      padding:22px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      box-sizing:border-box;
      z-index:2;
      position:relative;
    }

    .top{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .brand{ display:flex; gap:10px; align-items:center; }

    .badge{
      width:44px;height:44px;
      border-radius:16px;
      display:grid;place-items:center;
      background:rgba(255,77,141,0.16);
      border:1px solid rgba(255,77,141,0.25);
      box-shadow:0 10px 30px rgba(255,105,180,0.18);
      font-size:18px;
    }

    h1{ margin:0 0 4px; font-size:22px; color:#b3005e; }
    p{ margin:0; color:var(--muted); line-height:1.6; }

    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:12px 0 14px; align-items:center;
    }

    .btn{
      padding:10px 16px;
      border-radius:20px;
      font-weight:800;
      cursor:pointer;
      border:none;
      background:linear-gradient(135deg,var(--pink1),var(--pink2));
      color:white;
      box-shadow:0 10px 24px rgba(255,105,180,0.40);
      transition:transform .12s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 14px 28px rgba(255,105,180,0.55);
      filter:saturate(1.05);
    }

    /* Music UI */
    .music{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:18px;
      border:1px solid rgba(255,105,180,0.25);
      background:rgba(255,255,255,0.45);
      backdrop-filter: blur(10px);
    }
    .pill{
      font-weight:900;
      color:#b3005e;
      font-size:13px;
      opacity:.9;
      display:flex;
      align-items:center;
      gap:6px;
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background:rgba(179,0,94,0.35);
      box-shadow:0 0 0 6px rgba(255,105,180,0.10);
    }
    .dot.on{
      background:rgba(179,0,94,0.95);
      box-shadow:0 0 0 6px rgba(255,105,180,0.18), 0 0 18px rgba(255,105,180,0.45);
      animation:pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform:scale(1); }
      50%{ transform:scale(1.35); }
    }
    .vol{ width:110px; accent-color:#ff4d8d; }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:860px){ .grid{ grid-template-columns:1fr; } }

    .panel{
      background:rgba(255,255,255,0.35);
      border:1px solid rgba(255,105,180,0.18);
      border-radius:20px;
      padding:12px;
      box-sizing:border-box;
    }

    .title{
      font-size:13px;
      color:rgba(90,0,64,0.70);
      margin:0 0 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .progress{ font-size:12px; color:rgba(90,0,64,0.65); }

    #board{
      position:relative;
      width:100%;
      aspect-ratio:9/16;
      border-radius:20px;
      overflow:hidden;
      background:white;
      border:2px solid rgba(255,105,180,0.30);
      box-shadow:0 14px 30px rgba(255,105,180,0.16);
    }

    #tray{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      min-height:120px;
      align-content:flex-start;
    }

    .piece{
      width:var(--trayW);
      height:var(--trayH);
      border-radius:18px;
      border:2px solid rgba(255,105,180,0.28);
      background-image:var(--img);
      background-size:var(--bgSize);
      background-position:var(--bgPos);
      cursor:grab;
      user-select:none;
      box-shadow:0 10px 22px rgba(255,105,180,0.22);
      transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .piece:hover{
      transform:translateY(-1px) scale(1.03);
      border-color:rgba(255,105,180,0.40);
      box-shadow:0 16px 30px rgba(255,105,180,0.28);
    }
    .piece:active{ cursor:grabbing; transform:scale(0.99); }

    .piece.locked{
      cursor:default;
      box-shadow:0 10px 22px rgba(0,0,0,0.08);
      border-color:rgba(255,105,180,0.55);
      filter:saturate(1.05);
    }
    .piece.locked:hover{ transform:none; }

    .ghostSlot{
      position:absolute;
      border:1px dashed rgba(255,77,141,0.25);
      border-radius:14px;
      pointer-events:none;
    }

    .hint{
      margin-top:8px;
      font-size:13px;
      color:rgba(90,0,64,0.78);
      font-weight:800;
    }

    /* ‚úÖ SOLVED OVERLAY (center of WHOLE PAGE) */
    .solvedModal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:rgba(255,105,180,0.20);
      backdrop-filter: blur(12px);
      z-index:9997;
    }
    .solvedModal.open{ display:flex; }

    .solvedCard{
      width:min(860px, 94vw);
      min-height:min(72vh, 680px);
      background:linear-gradient(135deg,#fff0f6,#ffe6f2);
      border-radius:30px;
      border:1px solid rgba(255,105,180,0.32);
      box-shadow:0 34px 90px rgba(255,105,180,0.48);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      padding:18px;
      animation: popIn .28s ease-out both;
    }
    @keyframes popIn{
      from{ transform: translateY(10px) scale(0.96); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    /* Envelope animation */
    .env{
      width:min(520px, 92%);
      aspect-ratio: 16/10;
      position:relative;
      border-radius:28px;
      background:rgba(255,255,255,0.9);
      border:2px solid rgba(255,105,180,0.35);
      box-shadow:0 30px 70px rgba(255,105,180,0.30);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      animation: breathe 1.7s ease-in-out infinite;
    }
    @keyframes breathe{
      0%,100%{ transform:translateY(0) scale(1); }
      50%{ transform:translateY(-6px) scale(1.01); }
    }

    .env .shine{
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.60), transparent 55%);
      transform:rotate(18deg);
      opacity:0.7;
      pointer-events:none;
    }

    .env .flap{
      position:absolute;
      left:50%;
      top:18%;
      width:74%;
      height:54%;
      transform:translateX(-50%);
      background:linear-gradient(135deg,#fff0f6,#ffe6f2);
      border:2px solid rgba(255,105,180,0.35);
      border-bottom:none;
      clip-path: polygon(0 0, 100% 0, 50% 100%);
      transform-origin: 50% 0%;
      border-radius:18px 18px 0 0;
      box-shadow:0 18px 40px rgba(255,105,180,0.14);
    }

    .env .body{
      position:absolute;
      inset:18% 10% 14% 10%;
      border-radius:22px;
      background:linear-gradient(135deg,#fff9fc,#ffe6f2);
      border:2px solid rgba(255,105,180,0.25);
      overflow:hidden;
    }
    .env .seal{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-35%);
      width:54px; height:54px;
      border-radius:999px;
      background:linear-gradient(135deg,#ff4d8d,#ff7eb3);
      box-shadow:0 16px 35px rgba(255,105,180,0.35);
      display:grid;
      place-items:center;
      color:white;
      font-size:22px;
    }

    .env .tap{
      position:absolute;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      font-weight:1000;
      color:#b3005e;
      opacity:0.85;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
      font-size:14px;
    }
    .env .tap small{
      font-weight:900;
      color:rgba(90,0,64,0.62);
      font-size:12px;
      margin-top:-2px;
    }

    /* little hearts around envelope */
    .sparkHearts{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    .sparkHearts span{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      color:rgba(179,0,94,0.85);
      text-shadow:0 12px 28px rgba(255,105,180,0.25);
      opacity:0;
      animation: burst 1.6s ease-out infinite;
      font-size:18px;
    }
    .sparkHearts span:nth-child(1){ animation-delay:0s;   margin-left:-140px; margin-top:-60px; }
    .sparkHearts span:nth-child(2){ animation-delay:.25s;  margin-left:150px;  margin-top:-70px; }
    .sparkHearts span:nth-child(3){ animation-delay:.45s;  margin-left:-120px; margin-top:90px; }
    .sparkHearts span:nth-child(4){ animation-delay:.65s;  margin-left:140px;  margin-top:85px; }
    .sparkHearts span:nth-child(5){ animation-delay:.9s;   margin-left:0px;    margin-top:-130px; }
    @keyframes burst{
      0%{ opacity:0; transform:translate(-50%,-50%) scale(0.6); }
      20%{ opacity:0.95; }
      100%{ opacity:0; transform:translate(-50%,-80%) scale(1.35); }
    }

    /* Open letter animation */
    .letter{
      width:min(860px, 94vw);
      min-height:min(78vh, 760px);
      background:linear-gradient(135deg,#fff0f6,#ffe6f2);
      border-radius:32px;
      border:1px solid rgba(255,105,180,0.32);
      box-shadow:0 34px 90px rgba(255,105,180,0.50);
      position:relative;
      padding:18px;
      display:none;
      flex-direction:column;
      animation: letterIn .34s ease-out both;
    }
    @keyframes letterIn{
      from{ transform: translateY(16px) scale(0.95); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    .letterTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .letterTop h2{
      margin:0;
      font-size:18px;
      color:#b3005e;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .close{
      background:linear-gradient(135deg,var(--pink1),var(--pink2));
      border:none;
      color:white;
      border-radius:16px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:1000;
      box-shadow:0 10px 22px rgba(255,105,180,0.35);
    }

    .msg{
      white-space:pre-wrap;
      color:rgba(90,0,64,0.92);
      line-height:1.85;
      font-weight:800;
      font-size:18px;
      padding:10px 6px 0;
    }

    @media (max-width:520px){
      .music{ width:100%; justify-content:space-between; margin-left:0; }
      .vol{ width:120px; }
      .letter{ min-height:80vh; }
      .msg{ font-size:17px; }
    }
  </style>
</head>

<body>
  <div class="float-hearts" aria-hidden="true" id="floatHearts"></div>
  <canvas id="confetti"></canvas>

  <!-- Audio -->
  <audio id="bgMusic" preload="none" loop>
    <source src="love.mp3" type="audio/mpeg">
  </audio>

  <div class="card">
    <div class="top">
      <div class="brand">
        <div class="badge">‚ù§</div>
        <div>
          <h1>Solve the puzzle üëáüèª ‚ô•Ô∏è</h1>
          <p></p>
        </div>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="shuffleBtn">Shuffle</button>
      <button class="btn" id="restartBtn">Restart</button>
      <button class="btn" id="guideBtn">Toggle Guide</button>

      <div class="music">
        <div class="pill"><span class="dot" id="musicDot"></span> Music</div>
        <button class="btn" id="musicBtn" style="padding:10px 14px;border-radius:18px;">Play ‚ù§</button>
        <input class="vol" id="vol" type="range" min="0" max="1" step="0.01" value="0.5"/>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="title">
          <span>Board</span>
          <span class="progress" id="progress">0/16</span>
        </div>

        <div id="board"></div>
        <div class="hint" id="hint"></div>
      </div>

      <div class="panel">
        <div class="title"><span>Pieces tray</span></div>
        <div id="tray"></div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ SOLVED MODAL (center of page) -->
  <div class="solvedModal" id="solvedModal">
    <div class="solvedCard" id="solvedCard">
      <!-- Envelope view -->
      <div class="env" id="env">
        <div class="shine"></div>
        <div class="sparkHearts" aria-hidden="true">
          <span>‚ù§</span><span>‚ù§</span><span>‚ù§</span><span>‚ù§</span><span>‚ù§</span>
        </div>
        <div class="flap" id="flap"></div>
        <div class="body"></div>
        <div class="seal">‚ù§</div>
        <div class="tap">
          Tap to open ‚ù§
          <small>A little letter‚Ä¶</small>
        </div>
      </div>

      <!-- Letter view -->
      <div class="letter" id="letter">
        <div class="letterTop">
          <h2>‚ù§ A letter for you</h2>
          <button class="close" id="closeLetter">Close</button>
        </div>
        <div class="msg" id="letterMsg"></div>
      </div>
    </div>
  </div>

<script>
  const IMAGE_SRC = "puzzle.jpg";
  const ROWS = 4, COLS = 4;

  const finalMessage =
`Some sunsets are beautiful...
But you're my favourite sunset ‚ô•Ô∏è ‚ú®

Happy Valentine's Day my lovely Emy ‚ô•Ô∏è ‚ô•Ô∏è`;

  const board = document.getElementById("board");
  const tray = document.getElementById("tray");
  const hint = document.getElementById("hint");
  const progress = document.getElementById("progress");

  // solved modal elements
  const solvedModal = document.getElementById("solvedModal");
  const env = document.getElementById("env");
  const flap = document.getElementById("flap");
  const letter = document.getElementById("letter");
  const closeLetter = document.getElementById("closeLetter");
  const letterMsg = document.getElementById("letterMsg");
  letterMsg.textContent = finalMessage;

  closeLetter.addEventListener("click", () => {
    letter.style.display = "none";
    env.style.display = "flex";
    flap.style.transform = "translateX(-50%) rotateX(0deg)";
    solvedModal.classList.remove("open");
  });

  // prevent scroll only while dragging
  let isDragging = false;
  document.addEventListener("touchmove", (e) => { if (isDragging) e.preventDefault(); }, { passive:false });

  // music
  const bgMusic = document.getElementById("bgMusic");
  const musicBtn = document.getElementById("musicBtn");
  const vol = document.getElementById("vol");
  const musicDot = document.getElementById("musicDot");
  bgMusic.volume = parseFloat(vol.value);

  function setMusicUI(playing){
    musicBtn.textContent = playing ? "Pause ‚ù§" : "Play ‚ù§";
    musicDot.classList.toggle("on", playing);
  }
  async function playMusic(){
    try{ await bgMusic.play(); setMusicUI(true); }
    catch(e){ setMusicUI(false); }
  }
  function pauseMusic(){ bgMusic.pause(); setMusicUI(false); }

  musicBtn.addEventListener("click", async () => {
    if (bgMusic.paused) await playMusic();
    else pauseMusic();
  });
  vol.addEventListener("input", ()=> bgMusic.volume = parseFloat(vol.value));

  let armed = false;
  function armAutoplay(){
    if (armed) return;
    armed = true;
    playMusic();
    window.removeEventListener("pointerdown", armAutoplay, {capture:true});
    window.removeEventListener("touchstart", armAutoplay, {capture:true});
    window.removeEventListener("keydown", armAutoplay, {capture:true});
  }
  window.addEventListener("pointerdown", armAutoplay, {capture:true, passive:true});
  window.addEventListener("touchstart", armAutoplay, {capture:true, passive:true});
  window.addEventListener("keydown", armAutoplay, {capture:true});

  // confetti
  const confettiCanvas = document.getElementById("confetti");
  const ctx = confettiCanvas.getContext("2d");
  let confetti = [];
  let confettiRunning = false;

  function resizeConfetti(){
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeConfetti);
  resizeConfetti();

  function startConfetti(){
    if (confettiRunning) return;
    confettiRunning = true;

    confetti = Array.from({length: 220}, () => ({
      x: Math.random()*confettiCanvas.width,
      y: -20 - Math.random()*confettiCanvas.height*0.25,
      s: 3 + Math.random()*5,
      vy: 2 + Math.random()*4,
      vx: -1 + Math.random()*2,
      a: Math.random()*Math.PI*2,
      va: -0.12 + Math.random()*0.24,
      life: 200 + Math.random()*140
    }));

    requestAnimationFrame(tickConfetti);
    setTimeout(() => { confettiRunning = false; }, 2600);
  }

  function tickConfetti(){
    ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);

    for (const p of confetti){
      p.x += p.vx; p.y += p.vy; p.a += p.va; p.life -= 1;

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.a);

      const hue = 320 + Math.floor(Math.random()*45);
      ctx.fillStyle = `hsla(${hue}, 92%, 70%, 0.92)`;
      ctx.fillRect(-p.s, -p.s, p.s*2, p.s*2);

      ctx.restore();
    }

    confetti = confetti.filter(p => p.life > 0 && p.y < confettiCanvas.height + 40);

    if (confettiRunning || confetti.length){
      requestAnimationFrame(tickConfetti);
    } else {
      ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
    }
  }

  // floating hearts background
  const floatHearts = document.getElementById("floatHearts");
  const COUNT = 34;
  for(let i=0;i<COUNT;i++){
    const h = document.createElement("div");
    h.className = "heart";
    h.textContent = "‚ù§";
    const left = Math.random()*100;
    const dur = 7.5 + Math.random()*10.5;
    const delay = Math.random()*6;
    const scale = 0.55 + Math.random()*1.2;
    const drift = (Math.random()*120 - 60).toFixed(0) + "px";
    const rot = (Math.random()*260 - 130).toFixed(0) + "deg";
    const sway = (Math.random()*26 - 13).toFixed(0) + "px";
    const swayDur = (2.8 + Math.random()*3.2).toFixed(1) + "s";
    const twDur = (2.0 + Math.random()*3.5).toFixed(1) + "s";
    const size = (18 + Math.random()*34).toFixed(0) + "px";
    const opacity = (0.10 + Math.random()*0.22).toFixed(2);

    h.style.left = left + "vw";
    h.style.setProperty("--dur", dur.toFixed(1) + "s");
    h.style.setProperty("--delay", delay.toFixed(1) + "s");
    h.style.setProperty("--scale", scale.toFixed(2));
    h.style.setProperty("--drift", drift);
    h.style.setProperty("--rot", rot);
    h.style.setProperty("--sway", sway);
    h.style.setProperty("--swayDur", swayDur);
    h.style.setProperty("--twDur", twDur);
    h.style.fontSize = size;
    h.style.opacity = opacity;

    floatHearts.appendChild(h);
  }

  // puzzle
  const IMG = `url('${IMAGE_SRC}')`;
  let pieces = [];
  let showGuide = true;

  function shuffle(arr){
    const a = [...arr];
    for (let i=a.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function clearAll(){
    [...board.querySelectorAll(".ghostSlot")].forEach(x => x.remove());
    [...board.querySelectorAll(".piece")].forEach(x => x.remove());
    tray.innerHTML = "";
    pieces = [];
    solvedModal.classList.remove("open");
    letter.style.display = "none";
    env.style.display = "flex";
    flap.style.transform = "translateX(-50%) rotateX(0deg)";
  }

  function makeSlots(){
    const rect = board.getBoundingClientRect();
    const slotW = rect.width / COLS;
    const slotH = rect.height / ROWS;

    for (let r=0; r<ROWS; r++){
      for (let c=0; c<COLS; c++){
        const s = document.createElement("div");
        s.className = "ghostSlot";
        s.style.left = (c*slotW) + "px";
        s.style.top  = (r*slotH) + "px";
        s.style.width  = slotW + "px";
        s.style.height = slotH + "px";
        s.style.opacity = showGuide ? "1" : "0";
        board.appendChild(s);
      }
    }
  }

  function updateTrayPieceSize(){
    const boardRect = board.getBoundingClientRect();
    const slotW = boardRect.width / COLS;
    const slotH = boardRect.height / ROWS;

    const scale = 0.58;
    const trayW = Math.max(48, Math.floor(slotW * scale));
    const trayH = Math.max(70, Math.floor(slotH * scale));

    document.documentElement.style.setProperty("--trayW", trayW + "px");
    document.documentElement.style.setProperty("--trayH", trayH + "px");
  }

  function createPieces(){
    for (let r=0; r<ROWS; r++){
      for (let c=0; c<COLS; c++){
        const correctIdx = r*COLS + c;
        const d = document.createElement("div");
        d.className = "piece";
        d.dataset.correct = String(correctIdx);
        d.dataset.placed = "0";
        d.dataset.locked = "0";
        d.style.setProperty("--img", IMG);
        d.style.setProperty("--bgSize", `${COLS*100}% ${ROWS*100}%`);

        const posX = (c/(COLS-1||1))*100;
        const posY = (r/(ROWS-1||1))*100;
        d.style.setProperty("--bgPos", `${posX}% ${posY}%`);

        pieces.push(d);
      }
    }

    pieces = shuffle(pieces);
    pieces.forEach(p => tray.appendChild(p));
    attachDrag();
    updateProgress();
    hint.textContent = "Start ‚ù§";
  }

  function placedCount(){ return board.querySelectorAll(".piece").length; }
  function updateProgress(){ progress.textContent = `${placedCount()}/${ROWS*COLS}`; }
  function isLocked(el){ return el && el.dataset && el.dataset.locked === "1"; }

  function checkSolved(){
    updateProgress();

    const placed = [...board.querySelectorAll(".piece")];
    if (placed.length !== ROWS*COLS){
      hint.textContent = `Placed ${placed.length}/${ROWS*COLS}`;
      return;
    }

    let ok = true;
    for (const p of placed){
      const correct = parseInt(p.dataset.correct, 10);
      const slot = parseInt(p.dataset.slot, 10);
      if (correct !== slot){ ok = false; break; }
    }

    if (ok){
      hint.textContent = "Perfect ‚ù§";
      solvedModal.classList.add("open");
      startConfetti();
    } else {
      hint.textContent = "Almost‚Ä¶ ‚ù§";
      solvedModal.classList.remove("open");
      letter.style.display = "none";
      env.style.display = "flex";
      flap.style.transform = "translateX(-50%) rotateX(0deg)";
    }
  }

  function shuffleTray(){
    const unplaced = [...tray.querySelectorAll(".piece")].filter(p => p.dataset.locked !== "1");
    const s = shuffle(unplaced);
    tray.innerHTML = "";
    s.forEach(x => tray.appendChild(x));
  }

  function attachDrag(){
    pieces.forEach(p => {
      if (p.dataset.dragBound === "1") return;
      p.dataset.dragBound = "1";

      p.addEventListener("pointerdown", (e) => {
        if (p.dataset.locked === "1") return;

        e.preventDefault();
        p.setPointerCapture(e.pointerId);
        isDragging = true;

        const startedInBoard = (p.dataset.placed === "1");
        const fromSlot = startedInBoard ? parseInt(p.dataset.slot, 10) : null;

        const startX = e.clientX, startY = e.clientY;
        const origRect = p.getBoundingClientRect();

        p.style.visibility = "hidden";

        const clone = p.cloneNode(true);
        clone.classList.remove("locked");
        clone.style.position = "fixed";
        clone.style.left = origRect.left + "px";
        clone.style.top = origRect.top + "px";
        clone.style.width = origRect.width + "px";
        clone.style.height = origRect.height + "px";
        clone.style.margin = "0";
        clone.style.zIndex = "9996";
        clone.style.opacity = "0.95";
        clone.style.cursor = "grabbing";
        document.body.appendChild(clone);

        const endDrag = () => { isDragging = false; };

        const move = (ev) => {
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          clone.style.transform = `translate(${dx}px, ${dy}px)`;
        };

        const snapPieceToSlot = (pieceEl, targetIdx) => {
          const boardRect = board.getBoundingClientRect();
          const slotW = boardRect.width / COLS;
          const slotH = boardRect.height / ROWS;
          const r = Math.floor(targetIdx / COLS);
          const c = targetIdx % COLS;

          pieceEl.dataset.slot = String(targetIdx);
          pieceEl.dataset.placed = "1";

          pieceEl.style.position = "absolute";
          pieceEl.style.left = (c*slotW) + "px";
          pieceEl.style.top  = (r*slotH) + "px";
          pieceEl.style.width  = slotW + "px";
          pieceEl.style.height = slotH + "px";
          pieceEl.style.borderRadius = "14px";
          pieceEl.style.cursor = (pieceEl.dataset.locked === "1") ? "default" : "grab";
          pieceEl.style.visibility = "";

          board.appendChild(pieceEl);
        };

        const returnToOrigin = () => {
          if (startedInBoard && fromSlot !== null){
            snapPieceToSlot(p, fromSlot);
          } else {
            p.dataset.placed = "0";
            p.removeAttribute("data-slot");
            p.style.position = "";
            p.style.left = "";
            p.style.top = "";
            p.style.width = "";
            p.style.height = "";
            p.style.cursor = "grab";
            p.style.visibility = "";
            tray.appendChild(p);
          }
          checkSolved();
        };

        const dropIntoTray = () => {
          p.dataset.placed = "0";
          p.removeAttribute("data-slot");
          p.style.position = "";
          p.style.left = "";
          p.style.top = "";
          p.style.width = "";
          p.style.height = "";
          p.style.cursor = "grab";
          p.style.visibility = "";
          tray.appendChild(p);
          checkSolved();
        };

        const lockIfCorrect = (pieceEl) => {
          const correct = parseInt(pieceEl.dataset.correct, 10);
          const slot = parseInt(pieceEl.dataset.slot, 10);
          if (correct === slot){
            pieceEl.dataset.locked = "1";
            pieceEl.classList.add("locked");
            pieceEl.style.cursor = "default";
          }
        };

        const up = (ev) => {
          p.releasePointerCapture(e.pointerId);
          window.removeEventListener("pointermove", move);
          window.removeEventListener("pointerup", up);

          const boardRect = board.getBoundingClientRect();
          const dropX = ev.clientX, dropY = ev.clientY;

          const onBoard =
            dropX >= boardRect.left && dropX <= boardRect.right &&
            dropY >= boardRect.top  && dropY <= boardRect.bottom;

          if (!onBoard){
            clone.remove();
            dropIntoTray();
            endDrag();
            return;
          }

          const localX = dropX - boardRect.left;
          const localY = dropY - boardRect.top;

          const slotW = boardRect.width / COLS;
          const slotH = boardRect.height / ROWS;

          const c = Math.max(0, Math.min(COLS-1, Math.floor(localX / slotW)));
          const r = Math.max(0, Math.min(ROWS-1, Math.floor(localY / slotH)));
          const targetIdx = r*COLS + c;

          const occupant = board.querySelector(`.piece[data-slot='${targetIdx}']`);

          if (isLocked(occupant)){
            clone.remove();
            p.style.visibility = "";
            returnToOrigin();
            endDrag();
            return;
          }

          if (occupant && occupant !== p){
            if (startedInBoard && fromSlot !== null && fromSlot !== targetIdx){
              const backOcc = board.querySelector(`.piece[data-slot='${fromSlot}']`);
              if (!backOcc){
                snapPieceToSlot(occupant, fromSlot);
              } else {
                if (!isLocked(occupant)){
                  occupant.dataset.placed = "0";
                  occupant.removeAttribute("data-slot");
                  occupant.style.position = "";
                  occupant.style.left = "";
                  occupant.style.top = "";
                  occupant.style.width = "";
                  occupant.style.height = "";
                  occupant.style.cursor = "grab";
                  tray.appendChild(occupant);
                }
              }
            } else {
              if (!isLocked(occupant)){
                occupant.dataset.placed = "0";
                occupant.removeAttribute("data-slot");
                occupant.style.position = "";
                occupant.style.left = "";
                occupant.style.top = "";
                occupant.style.width = "";
                occupant.style.height = "";
                occupant.style.cursor = "grab";
                tray.appendChild(occupant);
              }
            }
          }

          snapPieceToSlot(p, targetIdx);
          lockIfCorrect(p);

          clone.remove();
          checkSolved();
          endDrag();
        };

        window.addEventListener("pointermove", move);
        window.addEventListener("pointerup", up);
      });
    });
  }

  // Open envelope -> show letter with animation
  env.addEventListener("click", () => {
    // flap animation
    flap.style.transition = "transform .45s ease";
    flap.style.transform = "translateX(-50%) rotateX(180deg)";

    // show letter after a tiny delay
    setTimeout(() => {
      env.style.display = "none";
      letter.style.display = "flex";
      if (bgMusic.paused) playMusic();
    }, 260);
  });

  // buttons
  document.getElementById("shuffleBtn").addEventListener("click", shuffleTray);
  document.getElementById("restartBtn").addEventListener("click", init);
  document.getElementById("guideBtn").addEventListener("click", () => {
    showGuide = !showGuide;
    [...board.querySelectorAll(".ghostSlot")].forEach(s => s.style.opacity = showGuide ? "1" : "0");
  });

  function init(){
    clearAll();
    makeSlots();
    updateTrayPieceSize();
    createPieces();
  }

  const preload = new Image();
  preload.onload = () => init();
  preload.onerror = () => { hint.textContent = "Image not loading ‚ù§ (check puzzle.jpg name/path)"; init(); };
  preload.src = IMAGE_SRC + "?v=" + Date.now();
</script>
</body>
</html>
